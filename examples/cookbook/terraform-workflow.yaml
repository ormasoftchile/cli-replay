# yaml-language-server: $schema=https://raw.githubusercontent.com/ormasoftchile/cli-replay/main/schema/scenario.schema.json

# Terraform Workflow — init / plan / apply pipeline
#
# Demonstrates:
#   - Linear step sequence (each command runs exactly once)
#   - Multi-line JSON stdout (realistic Terraform output)
#   - Security allowlist restricting interception to 'terraform' only
#
# Usage:
#   cli-replay validate examples/cookbook/terraform-workflow.yaml
#   cli-replay exec examples/cookbook/terraform-workflow.yaml -- bash examples/cookbook/terraform-test.sh

meta:
  name: "terraform-workflow"
  description: "Terraform init/plan/apply pipeline with realistic output"
  vars:
    project: "my-infra"
    region: "us-east-1"
  security:
    allowed_commands:
      - terraform

steps:
  # Step 1: terraform init — download providers and initialize backend
  - match:
      argv: ["terraform", "init"]
    respond:
      exit: 0
      stdout: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching "~> 5.0"...
        - Installing hashicorp/aws v5.31.0...
        - Installed hashicorp/aws v5.31.0 (signed by HashiCorp)

        Terraform has been successfully initialized!

  # Step 2: terraform plan — preview infrastructure changes
  - match:
      argv: ["terraform", "plan", "-out=plan.tfplan"]
    respond:
      exit: 0
      stdout: |
        Terraform used the selected providers to generate the following execution plan.
        Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_instance.web will be created
          + resource "aws_instance" "web" {
              + ami                          = "ami-0c55b159cbfafe1f0"
              + instance_type                = "t3.micro"
              + tags                         = {
                  + "Name"    = "{{ .project }}-web"
                  + "Region"  = "{{ .region }}"
                }
            }

        Plan: 1 to add, 0 to change, 0 to destroy.

  # Step 3: terraform apply — execute the plan
  - match:
      argv: ["terraform", "apply", "plan.tfplan"]
    respond:
      exit: 0
      stdout: |
        aws_instance.web: Creating...
        aws_instance.web: Still creating... [10s elapsed]
        aws_instance.web: Creation complete after 15s [id=i-0abc123def456789]

        Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
